# 航次审批接口修改说明

## 修改概述
已将 `external_voyage_approval_api.py` 接口从返回风险筛查结果改为存储审批记录到KingBase数据库。

## 主要修改内容

### 1. 更新请求模型
- 添加了 `uuid` 字段作为唯一标识
- 更新了 `RelevantParty` 模型，添加了风险相关字段：
  - `risk_screening_status`: 风险筛查状态
  - `risk_change_status`: 风险变更状态  
  - `change_reason`: 变更原因
- 添加了 `approval_status` 和 `approval_time` 字段
- 将 `approvers` 改为 `Approver` 以匹配新的数据结构

### 2. 简化响应模型
- 将复杂的风险筛查响应模型替换为简单的操作结果模型：
  - `success`: 操作是否成功
  - `message`: 操作结果消息
  - `uuid`: 唯一标识

### 3. 实现数据库存储逻辑
- 添加了 `insert_approval_record()` 函数
- 将 `parties` 数组中的每个相关方拆分为独立的数据库记录
- 将审批人信息存储为JSONB格式
- 使用事务确保数据一致性

### 4. 修改接口逻辑
- 移除了复杂的风险筛查逻辑
- 简化为直接调用数据库插入函数
- 返回简单的成功/失败状态

## 数据库表结构
数据将存储到 `approval_records_table` 表中，每个相关方对应一条记录：

```sql
CREATE TABLE approval_records_table (
    id BIGSERIAL PRIMARY KEY,
    uuid VARCHAR(40) NOT NULL UNIQUE,
    voyage_number VARCHAR(20) NOT NULL,
    business_segment VARCHAR(50) NOT NULL,
    trade_type VARCHAR(50) NOT NULL,
    business_model VARCHAR(50) NOT NULL,
    vessel_imo VARCHAR(10) NOT NULL,
    vessel_name VARCHAR(100) NOT NULL,
    relevant_parties_type VARCHAR(200),
    parties_id VARCHAR(20),
    parties_name VARCHAR(500),
    risk_screening_status VARCHAR(20),
    risk_change_status VARCHAR(20),
    change_reason VARCHAR(2000),
    approval_status VARCHAR(20) NOT NULL,
    approval_date VARCHAR(100) NOT NULL,
    applicant_id VARCHAR(20) NOT NULL,
    applicant_name VARCHAR(100) NOT NULL,
    applicant_time TIMESTAMP NOT NULL,
    approvers JSONB NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## 使用方式
接口现在接受新的请求格式，并将数据存储到数据库中，返回简单的成功/失败状态。

## 测试
提供了 `test_voyage_approval_api.py` 测试脚本来验证接口功能。
